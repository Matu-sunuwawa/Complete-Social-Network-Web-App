{% extends 'core/base.html' %}
{% load static %}

{% block title %}Feed | Social App{% endblock %}

<style>
    .htmx-indicator {
        opacity: 0;
        visibility: hidden;
    }
    .htmx-request .htmx-indicator,
    .htmx-request.htmx-indicator {
        opacity: 1;
        visibility: visible;
        transition: opacity 200ms ease-in;
    }
</style>

{% block content %}
<div class="row align-items-start">

    {% include "core/includes/_left_sidebar.html" %}

    <div class="col col-md-9 col-lg-6">

        <form hx-post="{% url 'post:post_create' %}"
            hx-target="#post-list"
            hx-swap="innerHTML"
            hx-encoding="multipart/form-data"
            hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('image-container-create').classList.add('d-none'); }"
            class="bg-white rounded-5 p-3 mb-4">
            {% csrf_token %}

            <div class="d-flex align-items-center">
                <img src="{% static 'assets/Group 8.png' %}" alt="">
                <textarea name="content" class="form-control-search" rows="1" placeholder="Share something..." required></textarea>
            </div>

            <div id="image-container-create" class="mt-3 d-none">
                <div class="image-preview-wrapper">
                    <button type="button" class="btn-delete-image" onclick="handleImageRemove('create')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <img id="image-preview-create" src="" class="preview-img" alt="Preview">
                </div>
            </div>

            <div class="border-top d-flex justify-content-between pt-3 mt-3">
                <input type="file" name="image" accept="image/*" class="d-none" id="image-upload-create"
                    onchange="handleImagePreview(this, 'create')">

                <label for="image-upload-create" class="cursor-pointer">
                    <img src="{% static 'assets/image-24-outlined.svg' %}" alt="">
                </label>
                <button type="submit" class="btn btn-primary fw-medium px-4 rounded-3">Send</button>
            </div>
        </form>

        <div class="d-flex justify-content-between pt-3 mt-4">
          <h3 class="h5 text-black">Feeds</h3>
          <div class="d-flex text-color-category">
            <h3 class="h5 fw-medium px-3">Recents</h3>
            <h3 class="h5 fw-medium">Friends</h3>
          </div>
        </div>

        <div id="post-list">
          {% include 'core/partials/home.html' %}
        </div>

        <div class="d-flex justify-content-center my-4">
            <div id="spinner" class="spinner-border htmx-indicator" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

    </div>

    {% include "core/includes/_right_sidebar.html" %}

</div>

<div id="modals-here"
     class="modal fade"
     tabindex="-1"
     aria-labelledby="modals-here-label"
     aria-hidden="true">
</div>
<script>
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === "modals-here") {
            const modal = new bootstrap.Modal(document.getElementById('modals-here'));
            modal.show();
        }
    });

    function handleImagePreview(input, postId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(`image-preview-${postId}`);
                const container = document.getElementById(`image-container-${postId}`);
                const clearCheckbox = document.getElementById(`image-clear-${postId}`);

                if (preview) preview.src = e.target.result;
                if (container) container.classList.remove('d-none');
                if (clearCheckbox) clearCheckbox.checked = false;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function handleImageRemove(postId) {
        const container = document.getElementById(`image-container-${postId}`);
        const uploadInput = document.getElementById(`image-upload-${postId}`);
        const clearCheckbox = document.getElementById(`image-clear-${postId}`);

        if (container) container.classList.add('d-none');
        if (uploadInput) uploadInput.value = "";
        if (clearCheckbox) clearCheckbox.checked = true;
    }
</script>
{% endblock %}
