{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Social App{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

    <main class="container container-top">
        {% block content %}
        {% endblock %}
    </main>

    <div id="modals-here" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-5 p-2" id="modal-content-target">
                </div>
        </div>
    </div>

    {% include "core/includes/_mobile_nav.html" %}

    <div id="lightbox-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="background: rgba(0,0,0,0.9);">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 bg-transparent">

                <div class="modal-body p-0 text-center position-relative">
                    <button type="button"
                            class="btn-close btn-close-white lightbox-close-btn"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>

                    <button class="btn text-white position-absolute start-0 top-50 translate-middle-y fs-1"
                            id="prev-btn" onclick="changeImage(-1)" style="z-index: 10;">
                        <span>‹</span>
                    </button>

                    <img id="lightbox-img-target" src="" class="img-fluid rounded shadow"
                        style="max-height: 85vh; object-fit: contain;">

                    <button class="btn text-white position-absolute end-0 top-50 translate-middle-y fs-1"
                            id="next-btn" onclick="changeImage(1)" style="z-index: 10;">
                        <span>›</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/htmx.min.js' %}"></script>

    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });

        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === "modal-content-target") {
                selectedFiles = new DataTransfer();

                const modalElement = document.getElementById('modals-here');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
        });
        document.body.addEventListener('closeModal', function() {
            const modalElement = document.getElementById('modal-content-target').closest('.modal');
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
        });

        function updateActiveLinks() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('.menu-item-link').forEach(link => {
                link.classList.toggle('active', link.getAttribute('href') === currentPath);
            });
        }

        document.body.addEventListener('htmx:afterOnLoad', updateActiveLinks);
        window.addEventListener('load', updateActiveLinks);

        let selectedFiles = new DataTransfer();

        function handleMultipleImagePreview(input, containerId) {
            const container = document.getElementById(`image-preview-container-${containerId}`);

            if (input.files) {
                Array.from(input.files).forEach((file) => {
                    selectedFiles.items.add(file);

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'position-relative d-inline-block m-1';
                        wrapper.style.width = '100px';
                        wrapper.style.height = '100px';

                        wrapper.innerHTML = `
                            <img src="${e.target.result}" class="rounded-3 w-100 h-100" style="object-fit: cover; border: 1px solid #ddd;">
                            <button type="button" class="btn btn-danger btn-sm rounded-circle position-absolute top-0 end-0 m-1 p-0 d-flex align-items-center justify-content-center"
                                    style="width:20px; height:20px; transform: translate(30%, -30%);"
                                    onclick="removeSingleImage(this, '${file.name}', '${containerId}')">
                                <small>×</small>
                            </button>
                        `;
                        container.appendChild(wrapper);
                    };
                    reader.readAsDataURL(file);
                });

                input.files = selectedFiles.files;
            }
        }

        function removeSingleImage(btn, fileName, containerId) {
            const newFiles = new DataTransfer();
            const input = document.getElementById(`image-upload-${containerId}`);

            Array.from(selectedFiles.files).forEach(file => {
                if (file.name !== fileName) {
                    newFiles.items.add(file);
                }
            });

            selectedFiles = newFiles;
            input.files = selectedFiles.files;
            btn.parentElement.remove();
        }

        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.successful) {
                selectedFiles = new DataTransfer();
            }
        });

        let currentGallery = [];
        let currentIndex = 0;

        function openLightbox(index, imagesJson) {
            currentGallery = imagesJson;
            currentIndex = index;

            updateLightboxContent();

            const modalElement = document.getElementById('lightbox-modal');
            const modalInstance = new bootstrap.Modal(modalElement);
            modalInstance.show();
        }

            function changeImage(step) {
                currentIndex += step;

                if (currentIndex >= currentGallery.length) currentIndex = 0;
                if (currentIndex < 0) currentIndex = currentGallery.length - 1;

                updateLightboxContent();
            }

            function updateLightboxContent() {
                const imgElement = document.getElementById('lightbox-img-target');
                imgElement.src = currentGallery[currentIndex];

                const prevBtn = document.getElementById('prev-btn');
                const nextBtn = document.getElementById('next-btn');

                if (currentGallery.length <= 1) {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                } else {
                    prevBtn.style.display = 'block';
                    nextBtn.style.display = 'block';
                }
            }

            document.addEventListener('keydown', (e) => {
                const modal = document.getElementById('lightbox-modal');
                if (modal.classList.contains('show')) {
                    if (e.key === "ArrowLeft") changeImage(-1);
                    if (e.key === "ArrowRight") changeImage(1);
                }
            });
    </script>
</body>
</html>
